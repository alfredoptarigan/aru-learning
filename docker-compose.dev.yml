version: '3.8'

services:
  # Development overrides for app service
  app:
    build:
      target: development
    volumes:
      - .:/var/www/html
      - /var/www/html/vendor
      - /var/www/html/node_modules
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - APP_URL=http://aru-learning.local
    labels:
      - "traefik.http.routers.app.rule=Host(`aru-learning.local`)"
      - "traefik.http.routers.app.entrypoints=web"
      - "traefik.http.routers.app.tls=false"

  # Development: Traefik Dashboard
  traefik:
    ports:
      - "8080:8080"
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.local`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

  # Development: Vite Dev Server
  vite:
    image: node:24-alpine
    container_name: aru-learning-vite
    working_dir: /app
    command: npm run dev -- --host 0.0.0.0
    volumes:
      - .:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    environment:
      - VITE_DEV_SERVER_URL=http://localhost:5173
    networks:
      - app_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vite.rule=Host(`aru-learning.local`) && PathPrefix(`/@vite`, `/@fs`, `/node_modules`, `/resources`)"
      - "traefik.http.routers.vite.entrypoints=web"
      - "traefik.http.services.vite.loadbalancer.server.port=5173"

  # Development: MailHog for Email Testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: aru-learning-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - app_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailhog.rule=Host(`mail.local`)"
      - "traefik.http.routers.mailhog.entrypoints=web"
      - "traefik.http.services.mailhog.loadbalancer.server.port=8025"

  # Development: PostgreSQL Admin (pgAdmin)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: aru-learning-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@aru-learning.local
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    networks:
      - app_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`db.local`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
